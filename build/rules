# Common build rules. Expects $mode and $flags.

outdir = $builddir/$mode

rule compile
    command = $cc -g -Werror $warn -fcolor-diagnostics $flags -MD -MF $out.d $
                  -c $in -o $out
    depfile = $out.d
    deps    = gcc

rule link
    command = $cc $in $flags -o $out

rule test
    command = ./$in $args > $out

build $outdir/vorth.o:       compile vorth.c
    flags = $flags
build $outdir/vorth_test.o:  compile vorth_test.c
    flags = $flags
build $outdir/vorth_test:    link $outdir/vorth_test.o $outdir/vorth.o
    flags = $flags
build $outdir/vorth_test.ok: test $outdir/vorth_test
    flags = $flags
