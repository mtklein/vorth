# Common build rules. Expects $mode, $cflags and $ldflags.

outdir = $builddir/$mode

rule compile
    command = $cc -g -Werror $warn -fcolor-diagnostics $cflags -MD -MF $out.d $
                  -c $in -o $out
    depfile = $out.d
    deps    = gcc

rule link
    command = if [ $$(uname) = Linux ]; then $cc -o $out $in $ldflags -fuse-ld=lld -lm; $
                                        else $cc -o $out $in $ldflags; fi

rule test
    command = ./$in $args > $out

build $outdir/vorth.o:       compile vorth.c
build $outdir/vorth_test.o:  compile vorth_test.c
build $outdir/vorth_test:    link $outdir/vorth_test.o $outdir/vorth.o
build $outdir/vorth_test.ok: test $outdir/vorth_test
